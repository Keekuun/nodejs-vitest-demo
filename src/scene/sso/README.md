# å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰Demo

## å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰æµç¨‹è¯´æ˜

+ 1.ç”¨æˆ·è®¿é—®åº”ç”¨ Aï¼Œæœªç™»å½•ï¼Œè·³è½¬åˆ° SSO è®¤è¯ä¸­å¿ƒï¼›
+ 2.è®¤è¯ä¸­å¿ƒæ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼š
  - å¦‚æœæœªç™»å½•ï¼Œåˆ™å±•ç¤ºç™»å½•é¡µé¢ï¼›
  - å¦‚æœå·²ç™»å½•ï¼Œåˆ™ç”Ÿæˆ Token å¹¶é‡å®šå‘å›åº”ç”¨ Aï¼›
+ 3.åº”ç”¨ A æ‹¿ç€ Token å»è®¤è¯ä¸­å¿ƒéªŒè¯èº«ä»½ï¼› 
+ 4.éªŒè¯æˆåŠŸåï¼Œç”¨æˆ·å¯ä»¥è®¿é—®åº”ç”¨ Aï¼› 
+ 5.ç”¨æˆ·è®¿é—®åº”ç”¨ B æ—¶ï¼Œå†æ¬¡è®¿é—®è®¤è¯ä¸­å¿ƒå¹¶æºå¸¦ Tokenï¼› 
+ 6.è®¤è¯ä¸­å¿ƒéªŒè¯ Token åˆæ³•æ€§ï¼Œåˆæ³•åˆ™ç›´æ¥è·³è½¬å›åº”ç”¨ Bï¼› 
+ 7.åº”ç”¨ B è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå®Œæˆå…ç™»å½•è®¿é—®ã€‚

# å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰Demo è¯´æ˜æ–‡æ¡£

æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„å•ç‚¹ç™»å½•ç³»ç»Ÿï¼ˆSingle Sign-Onï¼‰ï¼Œæ”¯æŒå¤šä¸ªå­ç³»ç»Ÿå…±äº«ç™»å½•çŠ¶æ€ã€‚ç”¨æˆ·åªéœ€ç™»å½•ä¸€æ¬¡ï¼Œå³å¯è®¿é—®æ‰€æœ‰ä¿¡ä»»çš„åº”ç”¨ã€‚

## ğŸŒ åŠŸèƒ½æ¦‚è¿°

- ç”¨æˆ·åœ¨è®¤è¯ä¸­å¿ƒç™»å½•åï¼Œå¯ä»¥è®¿é—®å¤šä¸ªå—ä¿æŠ¤çš„å­ç³»ç»Ÿï¼ˆå¦‚ App Aã€App Bï¼‰ï¼›
- ä½¿ç”¨ JWT å®ç°æ— çŠ¶æ€ Token è®¤è¯ï¼›
- æ”¯æŒ Cookie å…±äº«ï¼Œé€‚ç”¨äºå¤šå­åŸŸåœºæ™¯ï¼›
- æ¨¡æ‹Ÿäº†å®Œæ•´çš„ SSO ç™»å½•ã€éªŒè¯ã€è·³è½¬æµç¨‹ï¼›
- å¯æ‰©å±•ä¸º OAuth2 / OpenID Connect ç­‰åè®®åŸºç¡€æ¡†æ¶ã€‚

## ğŸ”‘ æ ¸å¿ƒæµç¨‹å›¾è§£

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚       â”‚                     â”‚
â”‚   App A      â”œâ”€â”€â”€â”€â”€â”€â–¶â”‚     SSO Auth Center â”‚
â”‚ (Protected)  â”‚       â”‚    (Login & Token)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â–²                          â–²
â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚      â”‚                            â”‚
â”‚   App B     â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”                          â”‚
â”‚ (Protected) â”‚       â”‚ â””â”€â”€â–¶                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
### æµç¨‹è¯´æ˜

1. **ç”¨æˆ·è®¿é—® App A**ï¼Œæœªç™»å½•ï¼Œè¢«é‡å®šå‘è‡³ SSO è®¤è¯ä¸­å¿ƒï¼›
2. **SSO æ£€æŸ¥æ˜¯å¦å·²ç™»å½•**ï¼š
   - æœªç™»å½• â†’ æ˜¾ç¤ºç™»å½•é¡µï¼›
   - å·²ç™»å½• â†’ ç”Ÿæˆ Token å¹¶é‡å®šå‘å› App Aï¼›
3. **App A è·å– Token åè¯·æ±‚éªŒè¯æ¥å£**ï¼Œç¡®è®¤ç”¨æˆ·èº«ä»½ï¼›
4. **ç”¨æˆ·è®¿é—® App B**ï¼Œæºå¸¦å·²æœ‰ Tokenï¼›
5. **SSO éªŒè¯ Token åˆæ³•æ€§**ï¼Œåˆæ³•åˆ™è‡ªåŠ¨è·³è½¬å› App Bï¼›
6. **App B è·å–ç”¨æˆ·ä¿¡æ¯å¹¶å®Œæˆå…ç™»å½•è®¿é—®**ã€‚

## ğŸ§© æŠ€æœ¯æ ˆ

- Node.js + Expressï¼šæœåŠ¡ç«¯é€»è¾‘
- JWTï¼šToken ç”Ÿæˆä¸éªŒè¯
- Cookieï¼šè·¨åŸŸå…±äº« Token
- Axiosï¼šç”¨äºå†…éƒ¨é€šä¿¡
- HTML + åŸç”Ÿ JSï¼šå‰ç«¯é¡µé¢æ¨¡æ‹Ÿ

## ğŸ“¦ ç›®å½•ç»“æ„è¯´æ˜

```

sso/
â”œâ”€â”€ sso-server.ts        // SSO è®¤è¯ä¸­å¿ƒæœåŠ¡
â”œâ”€â”€ app-a.ts               // å­ç³»ç»Ÿ A ç¤ºä¾‹
â”œâ”€â”€ app-b.ts               // å­ç³»ç»Ÿ B ç¤ºä¾‹
â””â”€â”€ README.md              // å½“å‰æ–‡ä»¶
```
## ğŸš€ è¿è¡Œæ–¹å¼

### å®‰è£…ä¾èµ–ï¼ˆç¡®ä¿ä½ æœ‰ Node.js å’Œ npmï¼‰

```
bash
npm install express cookie-parser jsonwebtoken axios
```
### å¯åŠ¨æœåŠ¡

```
bash
node sso-server.js
node app-a.js
node app-b.js
```
ä¸‰ä¸ªæœåŠ¡åˆ†åˆ«è¿è¡Œåœ¨ä»¥ä¸‹ç«¯å£ï¼š

| æœåŠ¡ | åœ°å€ |
|------|------|
| SSO è®¤è¯ä¸­å¿ƒ | http://localhost:3000 |
| App A | http://localhost:3001 |
| App B | http://localhost:3002 |

## ğŸ§ª ä½¿ç”¨è¯´æ˜

### 1. è®¿é—® App A

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š

```

http://localhost:3001/protected
```
- è‹¥æœªç™»å½•ï¼Œä¼šè·³è½¬åˆ° SSO ç™»å½•é¡µï¼›
- æäº¤ç™»å½•åï¼Œä¼šè¢«é‡å®šå‘å› App Aï¼›
- é¡µé¢æ˜¾ç¤ºç”¨æˆ· IDï¼Œè¡¨ç¤ºç™»å½•æˆåŠŸã€‚

### 2. è®¿é—® App B

åœ¨åŒä¸€æµè§ˆå™¨ä¸­è®¿é—®ï¼š

```

http://localhost:3002/protected
```
- å› ä¸ºå·²åœ¨ SSO ç™»å½•ï¼Œä¸ä¼šå†æ¬¡è·³è½¬ç™»å½•ï¼›
- è‡ªåŠ¨è·å– Token å¹¶è·³è½¬è‡³ App Bï¼›
- é¡µé¢æ˜¾ç¤ºç”¨æˆ· IDï¼Œè¡¨ç¤ºå…ç™»å½•æˆåŠŸã€‚

### 3. æ³¨é”€æµç¨‹ï¼ˆç›®å‰éœ€æ‰‹åŠ¨æ¸…é™¤ Cookieï¼‰

ç”±äºæ˜¯æ¼”ç¤ºç¯å¢ƒï¼Œæ³¨é”€åŠŸèƒ½éœ€è¦æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨ Cookie æˆ–é‡å¯æœåŠ¡ã€‚

---

## ğŸ“ æ³¨æ„äº‹é¡¹

- æ‰€æœ‰å­ç³»ç»Ÿå…±äº« Cookie åŸŸåä¸º `.example.com`ï¼Œè¯·æ ¹æ®å®é™…åŸŸåé…ç½®ï¼›
- JWT è®¾ç½®äº† 1 å°æ—¶è¿‡æœŸæ—¶é—´ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®å¢åŠ åˆ·æ–°æœºåˆ¶ï¼›
- å¯é€šè¿‡ Redis ç¼“å­˜ session å®ç°åˆ†å¸ƒå¼ç®¡ç†ï¼›
- å»ºè®®å¼•å…¥ HTTPS æå‡å®‰å…¨æ€§ï¼›
- æ”¯æŒåç»­å‡çº§ä¸º OAuth2 æˆ– CAS åè®®ã€‚

---

## ğŸ› ï¸ å¦‚ä½•æ‰©å±•

æ¬¢è¿ç»§ç»­ä¼˜åŒ–æ­¤é¡¹ç›®ï¼š

- âœ… æ·»åŠ ç™»å‡ºæ¥å£ï¼Œé€šçŸ¥æ‰€æœ‰å­ç³»ç»Ÿæ¸…é™¤ Tokenï¼›
- âœ… ä½¿ç”¨ Redis ç¼“å­˜ä¼šè¯ä¿¡æ¯ï¼›
- âœ… æ”¯æŒ Token åˆ·æ–°ï¼ˆrefresh tokenï¼‰ï¼›
- âœ… å¼•å…¥ Vue/React å‰ç«¯é›†æˆç¤ºä¾‹ï¼›
- âœ… ä½¿ç”¨ Passport.js æ”¯æŒç¬¬ä¸‰æ–¹ç™»å½•ï¼›
- âœ… æ”¯æŒç§»åŠ¨ç«¯ Token è®¤è¯æµç¨‹ã€‚

# é—®é¢˜

> **æœ¬åœ°æµ‹è¯•åªèƒ½ä½¿ç”¨ä¸åŒç«¯å£ï¼ˆå¦‚ localhost:3000ã€localhost:3001ï¼‰ï¼Œè€Œ Cookie é»˜è®¤ä¸èƒ½è·¨ç«¯å£å…±äº«ã€‚**
>
> è·¨åŸŸ Cookie åªèƒ½å…±äº«åŒçˆ¶åŸŸåä¸‹çš„å­åŸŸï¼Œå¦‚ `app.local` å’Œ `sso.local`ã€‚

---

## âœ… æ ¸å¿ƒé—®é¢˜æ€»ç»“

| æ¡ä»¶ | æ˜¯å¦èƒ½å…±äº« Cookie |
|------|------------------|
| `localhost:3000` â `localhost:3001` | âŒ ä¸è¡Œï¼ˆç«¯å£ä¸åŒï¼‰ |
| `app.local:3000` â `sso.local:3001` | âœ… å¯ä»¥ï¼ˆç»Ÿä¸€çˆ¶åŸŸå `.local`ï¼‰ |

---

## ğŸš« ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨ `localhost`

- æµè§ˆå™¨å°† `localhost:3000` å’Œ `localhost:3001` è§†ä¸ºä¸¤ä¸ª**å®Œå…¨ä¸åŒçš„æºï¼ˆoriginï¼‰**
- å³ä½¿ä½ è®¾ç½®äº† `domain: 'localhost'`ï¼Œä¹Ÿä¸èƒ½è·¨ç«¯å£å…±äº« Cookie
- è¿™æ˜¯æµè§ˆå™¨çš„å®‰å…¨ç­–ç•¥å†³å®šçš„ï¼Œæ— æ³•ç»•è¿‡

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨è‡ªå®šä¹‰æœ¬åœ°åŸŸåï¼ˆæ¨èï¼‰

### ğŸ’¡ æ€è·¯ï¼š
- åœ¨æœ¬åœ°é…ç½®ä¸€ä¸ªå…¬å…±çš„çˆ¶åŸŸåï¼Œæ¯”å¦‚ `.local`
- æ‰€æœ‰å­ç³»ç»Ÿéƒ½ä½¿ç”¨è¿™ä¸ªåŸŸåçš„ä¸åŒå­åŸŸï¼ˆå¦‚ `app1.local`, `app2.local`, `sso.local`ï¼‰
- è®¾ç½® Cookie çš„ `domain: '.local'`ï¼Œè¿™æ ·æ‰€æœ‰å­åŸŸéƒ½èƒ½è®¿é—®åˆ° Token

---

## ğŸ› ï¸ æ­¥éª¤ä¸€ï¼šä¿®æ”¹ hosts æ–‡ä»¶ï¼Œæ·»åŠ æœ¬åœ°åŸŸåæ˜ å°„

æ‰“å¼€ä½ çš„ hosts æ–‡ä»¶ï¼š

```bash
# Mac/Linux
sudo nano /etc/hosts

# Windows
C:\Windows\System32\drivers\etc\hosts
```


æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```
127.0.0.1 app1.local
127.0.0.1 app2.local
127.0.0.1 sso.local
```


ä¿å­˜åä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®æœåŠ¡ï¼š

- App1: http://app1.local:3001
- App2: http://app2.local:3002
- SSO: http://sso.local:3000

---

## ğŸ› ï¸ æ­¥éª¤äºŒï¼šSSO è®¾ç½® Cookie åˆ° `.local` åŸŸå

åœ¨ `sso-server.ts` ä¸­è®¾ç½® Cookieï¼š

```ts
res.cookie('sso_token', token, {
    httpOnly: true,
    domain: '.local', // âš ï¸ æ³¨æ„å‰é¢æœ‰ä¸ªç‚¹
    path: '/',
    maxAge: 3600000, // ä¸ jwt expiresIn åŒ¹é…
});
```


è¿™æ ·æ‰€æœ‰å­åŸŸåéƒ½å¯ä»¥è¯»å–åˆ°è¿™ä¸ª Cookieã€‚

---

## ğŸ› ï¸ æ­¥éª¤ä¸‰ï¼šApp1 å’Œ App2 ä½¿ç”¨æ–°åŸŸåè®¿é—®

### ä¿®æ”¹åçš„ `/protected` è·¯ç”±ç¤ºä¾‹ï¼ˆApp1ï¼‰

```ts
app.get('/protected', async (req, res) => {
    const { sso_token } = req.cookies;

    if (!sso_token) {
        return res.redirect(`http://sso.local:3000/login?redirect=http://app1.local:3001/callback`);
    }

    try {
        const verifyRes = await axios.get(`http://sso.local:3000/verify?token=${sso_token}`);
        if (verifyRes.data.valid) {
            return res.send(`<h1>Welcome to App A</h1><p>User: ${verifyRes.data.user.userId}</p>`);
        }
    } catch (e) {
        return res.redirect(`http://sso.local:3000/login?redirect=http://app1.local:3001/callback`);
    }

    res.status(401).send('Unauthorized');
});
```


### ä¿®æ”¹åçš„ `/callback` ç¤ºä¾‹ï¼ˆApp1 & App2ï¼‰

```ts
app.get('/callback', (req, res) => {
    const { token } = req.query;

    if (!token || typeof token !== 'string') {
        return res.status(400).send('Missing token');
    }

    // Cookie å·²è¢« SSO è®¾ç½®å¥½ï¼Œæ— éœ€å†å†™å…¥
    res.redirect('/protected');
});
```


---

## ğŸ§ª æœ€ç»ˆéªŒè¯æµç¨‹

1. ç”¨æˆ·è®¿é—®ï¼š`http://app1.local:3001/protected`
2. æ—  Token â†’ è·³è½¬è‡³ï¼š`http://sso.local:3000/login?redirect=http://app1.local:3001/callback`
3. ç™»å½•æˆåŠŸåè·³è½¬å›ï¼š`http://app1.local:3001/callback?token=xxx`
4. SSO è®¾ç½® Cookie åˆ° `.local` åŸŸåä¸‹
5. ç”¨æˆ·è®¿é—® `http://app2.local:3002/protected`
6. å› ä¸º Cookie å­˜åœ¨äº `.local` ä¸‹ï¼Œè‡ªåŠ¨æºå¸¦ Token éªŒè¯ âœ…

---

## ğŸ“Œ å¦‚æœä½ åšæŒåªç”¨ localhost ç«¯å£ï¼ˆä¸æ¨èï¼‰

å¦‚æœä½ ç¡®å®æƒ³ç»§ç»­ä½¿ç”¨ `localhost:3000`, `localhost:3001`, `localhost:3002`ï¼Œé‚£ä½ å°±**å¿…é¡»æ”¾å¼ƒ Cookie å…±äº«æœºåˆ¶**ï¼Œæ”¹ä¸ºï¼š

### âœ… æ–¹æ¡ˆï¼šä½¿ç”¨ URL Query String ä¼  Tokenï¼ˆå·²å®ç°ï¼‰

- ç™»å½•å Token æ”¾åœ¨ redirect çš„ query ä¸­ï¼›
- æ¯ä¸ª App åœ¨ `/callback` æ¥å£ä¸­æŠŠ Token å†™å…¥è‡ªå·±çš„ Cookieï¼›
- æ¯æ¬¡ç™»å½•åªéœ€ä¸€æ¬¡ï¼Œåç»­è®¿é—®å„ App æ—¶ä¼šä»å„è‡ªçš„ `/callback` ä¸­è·å– Token å¹¶å†™å…¥æœ¬åœ° Cookieï¼›
- å®ç°â€œå•ç‚¹ç™»å½•â€çš„è§†è§‰ä½“éªŒã€‚

è¿™ç§æ–¹å¼è™½ç„¶ä¸æ˜¯çœŸæ­£çš„â€œå…¨å±€ Token å…±äº«â€ï¼Œä½†å¯ä»¥æ¨¡æ‹Ÿå‡ºç±»ä¼¼æ•ˆæœã€‚

---

## âœ… æ€»ç»“

| åœºæ™¯ | æ˜¯å¦å¯è¡Œ | å»ºè®® |
|------|----------|------|
| `localhost:3000` â `localhost:3001` | âŒ ä¸è¡Œ | Cookie ä½œç”¨åŸŸé™åˆ¶ |
| ä½¿ç”¨ `.local` åŸŸå | âœ… å®Œå…¨å¯è¡Œ | æ¨èæ–¹å¼ |
| ä½¿ç”¨ Query ä¼  Token + å„è‡ªå­˜ Cookie | âœ… å¯è¡Œ | æœ¬åœ°å¼€å‘å¯ç”¨æ›¿ä»£æ–¹æ¡ˆ |

---

## ğŸš€ å¦‚ä½•é€‰æ‹©ï¼Ÿ

| ç›®æ ‡ | æ¨èåšæ³• |
|------|-----------|
| æœ¬åœ°æµ‹è¯• | âœ… ä½¿ç”¨ `.local` åŸŸåï¼ˆç®€å•æœ‰æ•ˆï¼‰ |
| ç”Ÿäº§éƒ¨ç½² | âœ… ä½¿ç”¨ `.yourdomain.com` ç»Ÿä¸€ Cookie |
| å¿«é€Ÿæ¼”ç¤º | âœ… ä½¿ç”¨ Query ä¼  Tokenï¼ˆç®€å•å¿«é€Ÿï¼‰ |
