
> åœ¨çœŸå®åœºæ™¯ä¸­ï¼Œæ¯”å¦‚ä½¿ç”¨é’‰é’‰ã€å¾®ä¿¡ã€QQ ç­‰ç¬¬ä¸‰æ–¹ç™»å½•æˆæƒæ—¶ï¼Œå¹¶æ²¡æœ‰ cookie å…±äº«é—®é¢˜ã€‚è¿™æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ

---

## âœ… æ ¸å¿ƒç»“è®ºï¼š

> **è¿™äº›ç³»ç»Ÿå¹¶ä¸ä¾èµ– Cookie å®ç°èº«ä»½å…±äº«ï¼Œè€Œæ˜¯é€šè¿‡ Token æœºåˆ¶ + ç¬¬ä¸‰æ–¹è®¤è¯ä¸­å¿ƒå®Œæˆç»Ÿä¸€ç™»å½•çŠ¶æ€ç®¡ç†**ã€‚

---

## ğŸ§  è¯¦ç»†è§£é‡Š

### ğŸ“Œ åœºæ™¯ï¼šç”¨æˆ·åœ¨ App A ä½¿ç”¨é’‰é’‰ç™»å½•

1. ç”¨æˆ·ç‚¹å‡»â€œä½¿ç”¨é’‰é’‰ç™»å½•â€ï¼›
2. App A å°†ç”¨æˆ·é‡å®šå‘åˆ°é’‰é’‰è®¤è¯ä¸­å¿ƒï¼›
3. ç”¨æˆ·æ‰«ç /è´¦å·å¯†ç ç™»å½•åï¼Œé’‰é’‰è¿”å›ä¸€ä¸ª `access_token`ï¼›
4. App A è·å– `access_token` å¹¶ä¿å­˜åˆ°è‡ªå·±çš„æœåŠ¡ç«¯æˆ–å‰ç«¯ï¼›
5. ç”¨æˆ·è®¿é—® App B æ—¶ï¼ŒApp B å†æ¬¡å°†ç”¨æˆ·å¼•å¯¼è‡³é’‰é’‰è®¤è¯ä¸­å¿ƒï¼›
6. é’‰é’‰æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦å·²æœ‰ç™»å½•ä¼šè¯ï¼ˆé€šå¸¸æ˜¯é’‰é’‰è‡ªèº«çš„ Cookieï¼‰ï¼›
    - å¦‚æœæœ‰ï¼Œåˆ™ç›´æ¥è¿”å›æ–°çš„ `access_token`ï¼›
    - å¦‚æœæ²¡æœ‰ï¼Œå†æ¬¡è¦æ±‚ç”¨æˆ·ç™»å½•ï¼›
7. App B æ‹¿åˆ° Token åå®Œæˆç™»å½•ï¼Œæ— éœ€ç”¨æˆ·é‡æ–°è¾“å…¥è´¦å·å¯†ç  âœ…

---

## ğŸ” å®ç°åŸç†è¯¦è§£

### 1ï¸âƒ£ ä½¿ç”¨ OAuth2 / OpenID Connect åè®®ï¼ˆæ ‡å‡†åšæ³•ï¼‰

#### æ ¸å¿ƒè§’è‰²ï¼š
| è§’è‰² | è¯´æ˜ |
|------|------|
| **Resource Owner** | ç”¨æˆ· |
| **Client (App A / App B)** | å­ç³»ç»Ÿ |
| **Authorization Server** | ç¬¬ä¸‰æ–¹è®¤è¯ä¸­å¿ƒï¼ˆå¦‚é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ï¼‰ |
| **Resource Server** | å—ä¿æŠ¤èµ„æºæœåŠ¡å™¨ |

#### ç™»å½•æµç¨‹å¦‚ä¸‹ï¼š
```
User â”€â”€(è®¿é—® App A)â”€â”€> App A
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Redirect to DingTalk OAuth URL
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç”¨æˆ·åœ¨é’‰é’‰ç™»å½•é¡µé¢ç™»å½• â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ é’‰é’‰å›è°ƒ App A çš„ redirect_uri â”‚
  â”‚ å¸¦ä¸Š code æˆ– token          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ App A è·å– access_token â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ ç”¨æˆ·è®¿é—® App B â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ App B å†æ¬¡è·³è½¬é’‰é’‰æˆæƒé¡µ â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ é’‰é’‰å‘ç°ç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨è·³å› App B â”‚
   â”‚ å¸¦ä¸Šæ–°çš„ access_token       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ App B å®Œæˆç™»å½• â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## ğŸš« ä¸éœ€è¦ Cookie å…±äº«çš„åŸå› 

- æ‰€æœ‰å­ç³»ç»Ÿï¼ˆApp A/Bï¼‰éƒ½ä¿¡ä»»åŒä¸€ä¸ªç¬¬ä¸‰æ–¹è®¤è¯ä¸­å¿ƒï¼ˆå¦‚é’‰é’‰ï¼‰ï¼›
- æ¯ä¸ª App éƒ½æœ‰è‡ªå·±çš„ Token å’Œ sessionï¼›
- æµè§ˆå™¨ä¸é’‰é’‰ä¹‹é—´çš„ Cookie æ˜¯ç‹¬ç«‹çš„ï¼ˆå±äº `.dingtalk.com`ï¼‰ï¼Œç”¨äºé’‰é’‰å†…éƒ¨ç»´æŠ¤ç™»å½•çŠ¶æ€ï¼›
- App A/B ä¹‹é—´ä¸éœ€è¦å…±äº« Cookieï¼Œåªéœ€è¦ä¿¡ä»»é’‰é’‰é¢å‘çš„ Tokenï¼›
- Token é€šå¸¸ä»¥ JWT å½¢å¼å­˜åœ¨æœ¬åœ°å­˜å‚¨ï¼ˆlocalStorageï¼‰æˆ–å†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯ Cookie ä¸­ï¼›

---

## âœ… å®é™…å®ç°æ–¹å¼

### 1ï¸âƒ£ ç¬¬ä¸‰æ–¹ç™»å½•æµç¨‹ï¼ˆOAuth2 æˆæƒç æ¨¡å¼ï¼‰

#### App A å‘èµ·ç™»å½•è¯·æ±‚ï¼š

```http
GET https://oapi.dingtalk.com/connect/oauth2/sns_authorize?
    appid=APPID
    &response_type=code
    &redirect_uri=REDIRECT_URI
    &state=STATE
```


#### é’‰é’‰å›è°ƒä½ çš„ App Aï¼š

```
http://yourdomain.com/callback?code=xxxxxx&state=STATE
```


#### App A è¯·æ±‚é’‰é’‰æ¢å– access_tokenï¼š

```ts
const res = await axios.get('https://oapi.dingtalk.com/sns/gettoken', {
    params: {
        appid: 'YOUR_APPID',
        appsecret: 'YOUR_SECRET',
        code: 'xxxxxx'
    }
});
```


#### App A ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¹¶è®¾ç½®è‡ªå·±çš„ Tokenï¼š

```ts
res.cookie('app_a_token', generatedJwtToken, { domain: '.yourdomain.com' });
```


---

### 2ï¸âƒ£ App B ä½¿ç”¨åŒæ ·çš„é’‰é’‰æˆæƒæµç¨‹

- App B ä¹Ÿé…ç½®äº†é’‰é’‰ç™»å½•ï¼›
- ç”¨æˆ·è®¿é—® App B æ—¶è·³è½¬åˆ°é’‰é’‰ï¼›
- å› ä¸ºé’‰é’‰å·²ç»ç™»å½•è¿‡ï¼Œæ‰€ä»¥é’‰é’‰è‡ªåŠ¨è·³å› App Bï¼›
- App B è·å– Token å¹¶éªŒè¯ç”¨æˆ·èº«ä»½ï¼›
- è®¾ç½®è‡ªå·±çš„ Cookieï¼š`app_b_token`ï¼Œä½œç”¨åŸŸä¸º `.yourdomain.com`

---

## ğŸ§© è¿™ç§æ¨¡å¼çš„ä¼˜åŠ¿

| ç‰¹æ€§ | æè¿° |
|------|------|
| âœ… æ— éœ€ Cookie å…±äº« | æ¯ä¸ª App è‡ªå·±ç®¡ç†è‡ªå·±çš„ Token |
| âœ… æ”¯æŒè·¨åŸŸã€å¤šåŸŸå | æ‰€æœ‰ App åªéœ€ä¿¡ä»»åŒä¸€ä¸ªè®¤è¯ä¸­å¿ƒ |
| âœ… æ”¯æŒç™»å‡ºåŒæ­¥ | å¯é€šè¿‡ä¸­å¤®è®¤è¯ä¸­å¿ƒç™»å‡ºæ¥å£é€šçŸ¥æ‰€æœ‰å­ç³»ç»Ÿ |
| âœ… ç”Ÿäº§çº§å®‰å…¨ | ä½¿ç”¨ OAuth2 / OpenID Connect åè®® |
| âœ… å¤šå¹³å°æ”¯æŒ | Web / ç§»åŠ¨ç«¯ / å°ç¨‹åºé€šç”¨ |

---

## ğŸ› ï¸ å®é™…å¼€å‘å»ºè®®

### 1. ä½¿ç”¨æˆç†Ÿçš„ SSO è®¤è¯åè®®

- âœ… OAuth2
- âœ… OpenID Connectï¼ˆåŸºäº OAuth2ï¼‰
- âœ… CAS / SAMLï¼ˆä¼ä¸šçº§ SSOï¼‰

### 2. ä½¿ç”¨ä¸­é—´å±‚ç»Ÿä¸€ Token ç®¡ç†

ä½ å¯ä»¥æ­å»ºä¸€ä¸ªç»Ÿä¸€è®¤è¯ç½‘å…³ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚      â”‚              â”‚
â”‚  App A       â”œâ”€â”€â”€â”€â–¶â”‚ Auth Gateway â”‚
â”‚              â”‚      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â–²
                                â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Third Party  â”‚
                        â”‚ OAuth Server â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


è¿™æ · App A/B éƒ½åªéœ€ä¿¡ä»»è¿™ä¸ªä¸­é—´ç½‘å…³ï¼Œè€Œæ— éœ€å…³å¿ƒ Token æ¥è‡ªå“ªé‡Œã€‚

---

## ğŸ§ª ç¤ºä¾‹ï¼šå¤šä¸ªåº”ç”¨ä½¿ç”¨é’‰é’‰ç™»å½•ï¼ˆä¼ªä»£ç ï¼‰

```ts
// App A ç™»å½•é€»è¾‘
app.get('/login', () => {
    const dingtalkUrl = 'https://oapi.dingtalk.com/connect/oauth2/sns_authorize?' +
        'appid=YOUR_APPID' +
        '&redirect_uri=http://app-a.yourdomain.com/callback';
    res.redirect(dingtalkUrl);
});

// App B ç™»å½•é€»è¾‘
app.get('/login', () => {
    const dingtalkUrl = 'https://oapi.dingtalk.com/connect/oauth2/sns_authorize?' +
        'appid=YOUR_OTHER_APPID' +
        '&redirect_uri=http://app-b.yourdomain.com/callback';
    res.redirect(dingtalkUrl);
});
```


è™½ç„¶ App A å’Œ App B æ˜¯ä¸¤ä¸ªä¸åŒçš„åº”ç”¨ï¼Œä½†å®ƒä»¬éƒ½ä¿¡ä»»é’‰é’‰çš„èº«ä»½è®¤è¯ç»“æœã€‚

---

## ğŸ“Œ æ€»ç»“

| æ–¹æ¡ˆ | æ˜¯å¦å…±äº« Cookie | æè¿° |
|------|------------------|------|
| âŒ Cookie å…±äº« | âŒ ä¸å¯è¡Œ | è·¨åŸŸé™åˆ¶ä¸¥é‡ï¼Œä¸é€‚ç”¨äºç”Ÿäº§ |
| âœ… OAuth2 / OIDC | âœ… æ¨è | æ‰€æœ‰ App ä¿¡ä»»åŒä¸€ä¸ªè®¤è¯ä¸­å¿ƒ |
| âœ… Token è½¬å‘ | âœ… å¯è¡Œ | App A è·å– Token åè½¬å‘ç»™ App B |
| âœ… åç«¯ç»Ÿä¸€ç½‘å…³ | âœ… æ¨è | æ‰€æœ‰ App éƒ½èµ°ä¸€ä¸ªè®¤è¯å±‚ |
